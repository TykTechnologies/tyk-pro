# SSH_KEY ?= esteban
# s3_bucket ?= nested-stacks-poc
stack_name ?= kiki
filename ?= $(@:%.yaml=%)
# filename_packaged ?= $(filename)-packaged.yaml
filename_json ?= $(filename).json
# filename_jq ?= $(filename).jq
# infra_template := nested-stacks/infra/infra.yaml
# infra_output := infra-stack-output.json
# parsed_infra_output := clean-vars.json
# now ?= $(shell date +%m%d%Y)


# define build-vars
# 	@vpc=$(shell jq '.Stacks[0].Outputs[1].OutputValue' $(infra_output));\
# 	priv_sub1=$(shell jq '.Stacks[0].Outputs[6].OutputValue' $(infra_output));\
# 	priv_sub2=$(shell jq '.Stacks[0].Outputs[2].OutputValue' $(infra_output));\
# 	priv_sub3=$(shell jq '.Stacks[0].Outputs[5].OutputValue' $(infra_output));\
# 	pub_sub1=$(shell jq '.Stacks[0].Outputs[0].OutputValue' $(infra_output));\
# 	pub_sub2=$(shell jq '.Stacks[0].Outputs[3].OutputValue' $(infra_output));\
# 	pub_sub3=$(shell jq '.Stacks[0].Outputs[4].OutputValue' $(infra_output));\
# 	echo "Parsing infra output file: infra-stack-output.json ....";\
# 	echo "Generating clean json variable file: clean-vars.json ....";\
# 	jq -n --arg vpc "$$vpc" --arg priv_sub1 "$$priv_sub1" --arg priv_sub2 "$$priv_sub2" \
# 	--arg priv_sub3 "$$priv_sub3" --arg pub_sub1 "$$pub_sub1" --arg pub_sub2 "$$pub_sub2" --arg pub_sub3 "$$pub_sub3" \
# 	'{vpc: $$vpc ,private_subnet1: $$priv_sub1,private_subnet2: $$priv_sub2,private_subnet3: $$priv_sub3,pub_subnet1: $$pub_sub1,pub_subnet2: $$pub_sub2,pub_subnet3: $$pub_sub3,ssh_key: "$(SSH_KEY)" }' > $(parsed_infra_output);\
# 	echo "clean-vars.json generated ... OK"

# endef

.PHONY: clean *.yaml build infra

# parse: $(infra_output)
# 	$(build-vars) 

# infra: $(infra_template)
# 	@echo "Deploying infra stack: tyk-aws-infra-$(SSH_KEY) ..."
# 	aws cloudformation deploy --template-file $(infra_template) --stack-name tyk-aws-infra-$(SSH_KEY)
# 	aws cloudformation describe-stacks --stack-name tyk-aws-infra-$(SSH_KEY) > $(infra_output)
# 	$(build-vars)

# *.jq: parse
# 	@echo "Generate json values file for $@"
# 	@jq -f $@< $(parsed_infra_output) > $(@:%.jq=%).json
# 	@echo "$(@:%.jq=%).json generated ... OK"


*.yaml:
	@echo "Creating stack $@ ..."
	aws cloudformation deploy --template-file $@ --parameter-overrides file://$(filename_json) --capabilities CAPABILITY_IAM --stack-name $(stack_name)

clean:
	aws cloudformation delete-stack --stack-name $(stack_name)
# 	@echo "Cleaning packaged files generated by aws"
# 	rm -fv *packaged*.yaml

