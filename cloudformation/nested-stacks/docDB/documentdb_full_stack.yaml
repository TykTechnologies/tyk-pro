Description:  "AWS CloudFormation Sample Template DocumentDB_Quick_Create: Sample template showing how to create a DocumentDB DB cluster and DB instance. **WARNING** This template creates an Amazon DocumentDB resources and you will be billed for the AWS resources used if you create a stack from this template."

Parameters: 
  DBClusterName: 
    Default: "MyCluster"
    Description : "Cluster name"
    Type: "String"
    MinLength: "1"
    MaxLength: "64"
    AllowedPattern : "[a-zA-Z][a-zA-Z0-9]*(-[a-zA-Z0-9]+)*"
    ConstraintDescription : "Must begin with a letter and contain only alphanumeric characters."

  MasterUser:
    NoEcho: "true"
    Description : "The database admin account username"
    Type: "String"
    MinLength: "1"
    MaxLength: "16"
    AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*"
    ConstraintDescription : "Must begin with a letter and contain only alphanumeric characters."

  MasterPassword:
    NoEcho: "true"
    Description : "The database admin account password"
    Type: "String"
    MinLength: "1"
    MaxLength: "41"
    AllowedPattern : "[a-zA-Z0-9]+"
    ConstraintDescription : "must contain only alphanumeric characters."

  DBInstanceClass:
    Description : "Instance class. Please refer to: https://docs.aws.amazon.com/documentdb/latest/developerguide/db-instance-classes.html#db-instance-classes-by-region"
    Type: "String"
    AllowedValues:
      - db.t3.medium
      - db.r5.large
      - db.r5.xlarge
      - db.r5.2xlarge
      - db.r5.4xlarge
      - db.r5.12xlarge
      - db.r5.24xlarge                             
    ConstraintDescription : "Instance type must be of the ones supported for the region. Please refer to: https://docs.aws.amazon.com/documentdb/latest/developerguide/db-instance-classes.html#db-instance-classes-by-region"  

  DocDBSubnets:
    Description: Which subnets the DocDB instances should be deployed to.
    Type: List<AWS::EC2::Subnet::Id>

  DocDBSecurityGroup:
    Description: DocDB security group ID
    Type: CommaDelimitedList

Resources:
  DBCluster:
    Type: "AWS::DocDB::DBCluster"
    DeletionPolicy: Delete
    Properties:
      DBClusterIdentifier: !Ref DBClusterName
      MasterUsername: !Ref MasterUser
      MasterUserPassword: !Ref MasterPassword
      EngineVersion: 4.0.0
      DBSubnetGroupName : !Ref DBSubnetGroup
      Port : "27017"
      VpcSecurityGroupIds: !Ref DocDBSecurityGroup
      DBClusterParameterGroupName : !Ref DBParameterGroup
      # BackupRetentionPeriod : 5
      # PreferredBackupWindow : "23:00-23:59"
      # PreferredMaintenanceWindow : "sun:00:00-sun:05:00"
      # StorageEncrypted : true

  DBParameterGroup:
      Type: "AWS::DocDB::DBClusterParameterGroup"
      Properties:
        Description: "TLS disabled"
        Family: "docdb4.0"
        Parameters: 
          tls: "disabled"

  DBSubnetGroup: 
    Type: AWS::DocDB::DBSubnetGroup
    Properties: 
      DBSubnetGroupDescription: "document db subnet group"
      DBSubnetGroupName: "docdb-subnet-group"
      SubnetIds: !Ref DocDBSubnets

  DBInstance1:
    Type: "AWS::DocDB::DBInstance"
    Properties:
      DBClusterIdentifier: !Ref DBCluster
      DBInstanceIdentifier: DocDB1
      DBInstanceClass: !Ref DBInstanceClass

  DBInstance2:
    Type: "AWS::DocDB::DBInstance"
    Properties:
      DBClusterIdentifier: !Ref DBCluster
      DBInstanceIdentifier: DocDB2
      DBInstanceClass: !Ref DBInstanceClass

  DBInstance3:
    Type: "AWS::DocDB::DBInstance"
    Properties:
      DBClusterIdentifier: !Ref DBCluster
      DBInstanceIdentifier: DocDB3
      DBInstanceClass: !Ref DBInstanceClass

Outputs:
  ClusterId:
    Description: The resource id for the cluster; The cluster ID uniquely identifies the cluster and is used in things like IAM authentication policies.
    Value: !Ref DBCluster
  ClusterEndpoint:
    Description: The connection endpoint for the cluster
    Value: !GetAtt DBCluster.Endpoint
  ClusterReadEndpoint:
    Description: The reader endpoint for the cluster
    Value: !GetAtt DBCluster.ReadEndpoint
  ClusterPort:
    Description: The port number on which the cluster accepts connections
    Value: !GetAtt DBCluster.Port
  EngineVersion:
    Description: The mongo engine compatibility version
    Value: 4.0.0